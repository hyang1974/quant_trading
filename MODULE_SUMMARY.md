# 系统模块总结

## 一、系统模块划分

### 模块1：数据服务层（Data Service Layer）

**职责**：
- 历史数据获取（日线、分钟线、财务数据）
- 实时数据订阅（行情推送、资金流向）
- 数据清洗与存储（质量检查、异常处理、持久化）
- 统一数据接口封装

**技术选型**：
- 数据源：akshare（免费）、tushare pro（付费高质量）
- 存储：SQLite（开发）、PostgreSQL（生产）、Redis（缓存）

**自动化程度**：
- ✅ **必须自动化**：历史数据定时更新、实时数据订阅
- ⚠️ **建议人工干预**：数据异常时的处理决策

---

### 模块2：策略引擎层（Strategy Engine Layer）

**职责**：
- 策略框架（策略基类、信号生成接口）
- 技术指标库（MA、MACD、RSI、KDJ、布林带等）
- 策略管理（注册、参数管理、版本控制）
- 信号生成（基于策略逻辑生成买卖信号）

**策略类型**（中低频）：
- 趋势跟踪：双均线、布林带突破、ADX
- 均值回归：RSI超买超卖、布林带回归
- 多因子选股：技术+基本面、行业轮动
- 事件驱动：业绩预告、重大公告

**技术选型**：
- 策略框架：自研或backtrader
- 指标计算：pandas + numpy + talib
- 参数优化：scipy.optimize 或 optuna

**自动化程度**：
- ✅ **必须自动化**：信号计算、指标更新
- ⚠️ **建议人工干预**：策略参数调整、新策略上线前审核

---

### 模块3：回测引擎层（Backtesting Engine Layer）

**职责**：
- 历史回测（基于历史数据验证策略）
- 性能评估（收益率、夏普比率、最大回撤、胜率等）
- 回测报告（可视化图表、交易明细、风险分析）
- 参数优化（网格搜索、遗传算法）

**关键指标**（针对20-40%回撤容忍度）：
- 总收益率：目标年化15-30%
- 最大回撤：控制在40%以内
- 夏普比率：> 1.0
- 卡玛比率：年化收益/最大回撤 > 0.5
- 胜率：> 45%
- 盈亏比：> 1.5

**技术选型**：
- 回测框架：自研或backtrader
- 可视化：matplotlib + plotly
- 报告生成：Jupyter Notebook 或 HTML

**自动化程度**：
- ✅ **必须自动化**：回测执行、指标计算
- ⚠️ **建议人工干预**：回测结果分析、策略优化方向决策

---

### 模块4：风险管理层（Risk Management Layer）

**职责**：
- **仓位管理**：
  - 单只股票最大仓位（20-30%）
  - 总仓位控制（80-95%）
  - 行业/板块分散度
- **止损止盈**：
  - 固定止损（如-8%）
  - 移动止损（跟踪止盈）
  - 时间止损（持仓超过N天）
- **风险监控**：
  - 实时监控账户风险度
  - 单日最大亏损限制（如-3%）
  - 连续亏损次数限制
- **异常处理**：
  - 异常波动检测
  - 停牌/退市处理
  - 流动性风险

**风险控制规则**（针对20-40%回撤）：
```python
RISK_CONFIG = {
    'max_single_position': 0.25,      # 单股最大25%
    'max_total_position': 0.90,       # 总仓位90%
    'stop_loss_pct': -0.08,           # 止损-8%
    'take_profit_pct': 0.20,          # 止盈20%
    'max_daily_loss': -0.03,          # 单日最大亏损-3%
    'max_consecutive_loss': 5,        # 连续亏损5次暂停
    'max_drawdown_alert': 0.30,       # 回撤30%告警
    'max_drawdown_stop': 0.40,        # 回撤40%停止交易
}
```

**技术选型**：
- 风险计算：实时计算，独立模块
- 风控执行：优先级最高，可中断交易

**自动化程度**：
- ✅ **必须自动化**：所有风险检查、止损止盈执行
- ⚠️ **建议人工干预**：风险参数调整、极端情况处理

---

### 模块5：交易执行层（Trading Execution Layer）

**职责**：
- **QMT/MiniQMT接口封装**：
  - 账户登录、资金查询
  - 下单、撤单、查询委托
  - 持仓查询、成交查询
- **订单管理**：
  - 订单状态跟踪
  - 部分成交处理
  - 订单重试机制
- **交易日志**：
  - 所有交易记录
  - 异常情况记录

**QMT集成要点**：
- 需要安装QMT客户端
- 使用华泰证券提供的Python SDK
- MiniQMT适合个人使用（轻量版）

**技术选型**：
- QMT接口：华泰证券官方Python SDK
- 订单管理：自研订单状态机

**自动化程度**：
- ✅ **必须自动化**：信号到订单的转换、订单执行
- ⚠️ **建议人工干预**：首次下单确认、大额订单审核（>总资金20%）

---

### 模块6：监控告警层（Monitoring & Alerting Layer）

**职责**：
- **实时监控**：
  - 账户资金变化
  - 持仓盈亏
  - 策略运行状态
  - 系统健康度
- **告警机制**：
  - 风险告警（回撤超限、单日亏损）
  - 系统告警（连接断开、异常错误）
  - 交易告警（异常成交、订单失败）
- **日志管理**：
  - 结构化日志
  - 日志轮转
  - 关键操作审计

**告警规则**：
- 风险告警：回撤>30%、单日亏损>2%
- 系统告警：QMT连接断开、数据源异常
- 交易告警：订单失败、异常成交价格

**技术选型**：
- 日志：loguru
- 监控：Prometheus + Grafana（可选）
- 告警：邮件、微信、钉钉

**自动化程度**：
- ✅ **必须自动化**：监控数据采集、告警触发
- ⚠️ **建议人工干预**：告警处理决策

---

### 模块7：策略调度层（Strategy Scheduler Layer）

**职责**：
- **任务调度**：
  - 数据更新任务（每日收盘后）
  - 策略计算任务（盘前/盘中）
  - 回测任务（离线）
- **执行流程**：
  1. 数据更新 → 2. 策略计算 → 3. 风险检查 → 4. 生成订单 → 5. 执行交易
- **异常恢复**：
  - 任务失败重试
  - 断点续传

**调度时间建议**（中低频）：
- **盘前（9:00-9:25）**：数据更新、策略计算、生成交易计划
- **盘中（9:30-15:00）**：实时监控、风险检查、执行交易
- **盘后（15:00-18:00）**：数据归档、回测分析、报告生成

**技术选型**：
- 调度框架：APScheduler 或 celery
- 任务队列：Redis（轻量）或 RabbitMQ

**自动化程度**：
- ✅ **必须自动化**：定时任务执行
- ⚠️ **建议人工干预**：任务执行异常时的处理

---

## 二、自动化 vs 人工干预总结

### ✅ 必须自动化的部分

| 模块 | 自动化内容 |
|------|-----------|
| 数据服务层 | 历史数据定时更新、实时数据订阅 |
| 策略引擎层 | 信号计算、指标更新 |
| 回测引擎层 | 回测执行、指标计算 |
| 风险管理层 | **所有风险检查、止损止盈执行** |
| 交易执行层 | 信号到订单转换、订单执行 |
| 监控告警层 | 监控数据采集、告警触发 |
| 策略调度层 | 定时任务执行 |

### ⚠️ 建议人工干预的部分

| 模块 | 人工干预内容 |
|------|------------|
| 数据服务层 | 数据异常时的处理决策 |
| 策略引擎层 | 策略参数调整、新策略上线前审核 |
| 回测引擎层 | 回测结果分析、策略优化方向决策 |
| 风险管理层 | 风险参数调整、极端情况处理 |
| 交易执行层 | 首次下单确认、大额订单审核（>20%） |
| 监控告警层 | 告警处理决策 |
| 策略调度层 | 任务执行异常时的处理 |

### 🎯 关键决策点

1. **策略开发与优化** - 人工决策
2. **风险参数调整** - 人工决策
3. **首次交易确认** - 人工确认
4. **异常情况处理** - 人工决策
5. **回测结果分析** - 人工分析
6. **定期审查** - 人工审查（每周/每月）

---

## 三、模块间交互流程

```
数据服务层
    ↓ (提供数据)
策略引擎层 → 生成信号
    ↓
风险管理层 → 风险检查
    ↓ (通过)
交易执行层 → 执行交易
    ↓
监控告警层 → 监控和告警
    ↑
策略调度层 (统一调度)
```

**关键流程**：
1. 数据更新（自动）
2. 策略计算（自动）
3. 风险检查（自动，但参数调整需人工）
4. 订单生成（自动，大额需人工确认）
5. 交易执行（自动）
6. 监控告警（自动，处理需人工）

---

## 四、开发优先级

1. **Phase 1**：数据服务层 + 策略引擎层 + 回测引擎层
2. **Phase 2**：风险管理层
3. **Phase 3**：交易执行层
4. **Phase 4**：监控告警层 + 策略调度层
5. **Phase 5**：优化迭代

---

## 五、核心设计原则

1. **风险优先**：风险控制模块独立且优先级最高
2. **模块化设计**：各模块独立，便于维护和扩展
3. **可观测性**：完善的日志、监控和告警
4. **渐进式开发**：先回测验证，再模拟交易，最后实盘
5. **自动化与人工平衡**：关键环节自动化，重要决策人工干预

