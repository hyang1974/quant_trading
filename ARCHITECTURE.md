# 个人A股量化交易系统 - 技术架构设计

## 一、系统概述

### 1.1 设计目标
- **适用场景**：个人投资者，中低频交易（日线/小时线级别）
- **风险偏好**：接受20%~40%回撤，追求中高收益
- **交易通道**：华泰证券 QMT / MiniQMT
- **技术栈**：Python 3.9+

### 1.2 核心设计原则
1. **模块化设计**：各模块独立，便于维护和扩展
2. **风险优先**：风险控制模块独立且优先级最高
3. **可观测性**：完善的日志、监控和告警机制
4. **渐进式开发**：先回测验证，再模拟交易，最后实盘

---

## 二、系统模块划分

### 模块1：数据服务层（Data Service Layer）

#### 职责
- **历史数据获取**：日线、分钟线、财务数据、公告数据
- **实时数据订阅**：行情推送、资金流向、板块轮动
- **数据清洗与存储**：数据质量检查、异常值处理、数据持久化
- **数据接口封装**：统一的数据访问接口

#### 技术选型
- **数据源**：
  - akshare（免费，历史数据）
  - tushare pro（付费，数据质量高）
  - 聚宽/米筐（备用）
  - QMT数据接口（实时行情）
- **存储**：
  - SQLite（开发/小规模）
  - PostgreSQL（生产环境，支持时序数据）
  - Redis（缓存实时数据）

#### 自动化程度
- ✅ **必须自动化**：历史数据定时更新、实时数据订阅
- ⚠️ **建议人工干预**：数据异常时的处理决策

---

### 模块2：策略引擎层（Strategy Engine Layer）

#### 职责
- **策略框架**：策略基类、信号生成接口
- **技术指标库**：MA、MACD、RSI、KDJ、布林带等
- **策略管理**：策略注册、参数管理、版本控制
- **信号生成**：基于策略逻辑生成买卖信号

#### 策略类型建议（中低频）
1. **趋势跟踪策略**
   - 双均线交叉
   - 布林带突破
   - 趋势强度指标（ADX）

2. **均值回归策略**
   - RSI超买超卖
   - 布林带回归
   - 配对交易

3. **多因子选股策略**
   - 技术面 + 基本面
   - 行业轮动
   - 市值风格

4. **事件驱动策略**
   - 业绩预告
   - 重大公告
   - 资金异动

#### 技术选型
- **策略框架**：自研（灵活度高）或 backtrader（成熟框架）
- **指标计算**：pandas + numpy + talib
- **参数优化**：scipy.optimize 或 optuna

#### 自动化程度
- ✅ **必须自动化**：信号计算、指标更新
- ⚠️ **建议人工干预**：策略参数调整、新策略上线前的审核

---

### 模块3：回测引擎层（Backtesting Engine Layer）

#### 职责
- **历史回测**：基于历史数据验证策略
- **性能评估**：收益率、夏普比率、最大回撤、胜率等
- **回测报告**：可视化图表、交易明细、风险分析
- **参数优化**：网格搜索、遗传算法等优化方法

#### 关键指标（针对20-40%回撤容忍度）
- **总收益率**：目标年化15-30%
- **最大回撤**：控制在40%以内
- **夏普比率**：> 1.0
- **卡玛比率**：年化收益/最大回撤 > 0.5
- **胜率**：> 45%
- **盈亏比**：> 1.5

#### 技术选型
- **回测框架**：自研（精确控制）或 backtrader
- **可视化**：matplotlib + plotly
- **报告生成**：Jupyter Notebook 或 HTML报告

#### 自动化程度
- ✅ **必须自动化**：回测执行、指标计算
- ⚠️ **建议人工干预**：回测结果分析、策略优化方向决策

---

### 模块4：风险管理层（Risk Management Layer）

#### 职责
- **仓位管理**：
  - 单只股票最大仓位（建议20-30%）
  - 总仓位控制（建议80-95%）
  - 行业/板块分散度
- **止损止盈**：
  - 固定止损（如-8%）
  - 移动止损（跟踪止盈）
  - 时间止损（持仓超过N天强制平仓）
- **风险监控**：
  - 实时监控账户风险度
  - 单日最大亏损限制（如-3%）
  - 连续亏损次数限制
- **异常处理**：
  - 异常波动检测
  - 停牌/退市处理
  - 流动性风险

#### 风险控制规则（针对20-40%回撤）
```python
# 示例风险参数
RISK_CONFIG = {
    'max_single_position': 0.25,      # 单股最大25%
    'max_total_position': 0.90,       # 总仓位90%
    'stop_loss_pct': -0.08,           # 止损-8%
    'take_profit_pct': 0.20,          # 止盈20%
    'max_daily_loss': -0.03,          # 单日最大亏损-3%
    'max_consecutive_loss': 5,        # 连续亏损5次暂停
    'max_drawdown_alert': 0.30,       # 回撤30%告警
    'max_drawdown_stop': 0.40,        # 回撤40%停止交易
}
```

#### 技术选型
- **风险计算**：实时计算，独立模块
- **风控执行**：优先级最高，可中断交易

#### 自动化程度
- ✅ **必须自动化**：所有风险检查、止损止盈执行
- ⚠️ **建议人工干预**：风险参数调整、极端情况处理

---

### 模块5：交易执行层（Trading Execution Layer）

#### 职责
- **QMT/MiniQMT接口封装**：
  - 账户登录、资金查询
  - 下单、撤单、查询委托
  - 持仓查询、成交查询
- **订单管理**：
  - 订单状态跟踪
  - 部分成交处理
  - 订单重试机制
- **交易日志**：
  - 所有交易记录
  - 异常情况记录

#### QMT/MiniQMT集成要点
```python
# QMT Python接口示例结构
class QMTTrader:
    """
    华泰证券QMT交易接口封装
    需要安装QMT客户端并配置
    """
    def __init__(self, account_id, password):
        # 连接QMT
        pass
    
    def buy(self, symbol, price, quantity):
        """买入"""
        # 调用QMT API
        pass
    
    def sell(self, symbol, price, quantity):
        """卖出"""
        # 调用QMT API
        pass
    
    def get_position(self):
        """获取持仓"""
        pass
    
    def get_balance(self):
        """获取资金"""
        pass
```

#### 技术选型
- **QMT接口**：华泰证券提供的Python SDK
- **MiniQMT**：轻量版，适合个人使用
- **订单管理**：自研订单状态机

#### 自动化程度
- ✅ **必须自动化**：信号到订单的转换、订单执行
- ⚠️ **建议人工干预**：首次下单确认、大额订单审核

---

### 模块6：监控告警层（Monitoring & Alerting Layer）

#### 职责
- **实时监控**：
  - 账户资金变化
  - 持仓盈亏
  - 策略运行状态
  - 系统健康度
- **告警机制**：
  - 风险告警（回撤超限、单日亏损）
  - 系统告警（连接断开、异常错误）
  - 交易告警（异常成交、订单失败）
- **日志管理**：
  - 结构化日志
  - 日志轮转
  - 关键操作审计

#### 告警规则
- **风险告警**：回撤>30%、单日亏损>2%
- **系统告警**：QMT连接断开、数据源异常
- **交易告警**：订单失败、异常成交价格

#### 技术选型
- **日志**：loguru
- **监控**：Prometheus + Grafana（可选）
- **告警**：邮件、微信、钉钉

#### 自动化程度
- ✅ **必须自动化**：监控数据采集、告警触发
- ⚠️ **建议人工干预**：告警处理决策

---

### 模块7：策略调度层（Strategy Scheduler Layer）

#### 职责
- **任务调度**：
  - 数据更新任务（每日收盘后）
  - 策略计算任务（盘前/盘中）
  - 回测任务（离线）
- **执行流程**：
  1. 数据更新 → 2. 策略计算 → 3. 风险检查 → 4. 生成订单 → 5. 执行交易
- **异常恢复**：
  - 任务失败重试
  - 断点续传

#### 调度时间建议（中低频）
- **盘前（9:00-9:25）**：数据更新、策略计算、生成交易计划
- **盘中（9:30-15:00）**：实时监控、风险检查、执行交易
- **盘后（15:00-18:00）**：数据归档、回测分析、报告生成

#### 技术选型
- **调度框架**：APScheduler 或 celery
- **任务队列**：Redis（轻量）或 RabbitMQ

#### 自动化程度
- ✅ **必须自动化**：定时任务执行
- ⚠️ **建议人工干预**：任务执行异常时的处理

---

## 三、系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                   监控告警层                              │
│          (实时监控、告警、日志)                           │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   策略调度层                              │
│          (任务调度、流程编排)                             │
└─────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┴───────────────────┐
        ↓                                       ↓
┌───────────────┐                    ┌───────────────┐
│  策略引擎层    │                    │  风险管理层    │
│ (信号生成)    │◄───风险检查────────►│ (仓位/止损)   │
└───────────────┘                    └───────────────┘
        ↓                                       ↓
        └───────────────────┬───────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   交易执行层                              │
│              (QMT接口、订单管理)                         │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   数据服务层                              │
│        (数据获取、存储、QMT实时行情)                      │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   回测引擎层                              │
│          (历史回测、性能评估)                             │
└─────────────────────────────────────────────────────────┘
```

---

## 四、自动化 vs 人工干预建议

### ✅ 必须自动化的部分

1. **数据更新**
   - 每日收盘后自动更新历史数据
   - 实时行情自动订阅和存储

2. **策略计算**
   - 定时计算技术指标
   - 自动生成交易信号

3. **风险检查**
   - 每次交易前自动检查风险规则
   - 实时监控账户风险度

4. **订单执行**
   - 信号到订单的自动转换
   - 订单自动提交到QMT

5. **止损止盈**
   - 达到止损/止盈条件自动平仓
   - 移动止损自动更新

6. **监控告警**
   - 系统异常自动告警
   - 风险超限自动告警

### ⚠️ 建议人工干预的部分

1. **策略开发与优化**
   - 新策略上线前的审核
   - 策略参数调整决策
   - 策略失效时的下线决策

2. **风险参数调整**
   - 根据市场环境调整风险参数
   - 极端情况下的风险控制决策

3. **首次交易确认**
   - 新策略首次实盘交易建议人工确认
   - 大额订单（如>总资金20%）建议人工确认

4. **异常情况处理**
   - 数据异常时的处理决策
   - 系统故障时的应急处理
   - QMT连接异常时的处理

5. **回测结果分析**
   - 回测报告的人工分析
   - 策略优化方向决策

6. **定期审查**
   - 每周/每月策略表现回顾
   - 风险控制效果评估
   - 系统优化方向决策

---

## 五、技术栈推荐

### 核心框架
- **Python 3.9+**
- **pandas** - 数据处理
- **numpy** - 数值计算
- **SQLAlchemy** - ORM
- **APScheduler** - 任务调度

### 数据相关
- **akshare** - 免费数据源
- **tushare pro** - 付费高质量数据
- **PostgreSQL** - 时序数据存储
- **Redis** - 实时数据缓存

### 策略回测
- **backtrader** 或自研 - 回测框架
- **talib** - 技术指标库
- **matplotlib/plotly** - 可视化

### 交易接口
- **QMT Python SDK** - 华泰证券官方接口
- **MiniQMT** - 轻量版接口

### 监控日志
- **loguru** - 日志管理
- **prometheus + grafana** - 监控（可选）

---

## 六、开发优先级建议

### Phase 1: 基础建设（2-3周）
1. 数据获取模块
2. 数据存储模块
3. 基础策略框架
4. 简单回测引擎

### Phase 2: 策略开发（2-3周）
1. 开发2-3个基础策略
2. 完善回测功能
3. 参数优化工具
4. 回测报告生成

### Phase 3: 风险控制（1-2周）
1. 风险管理模块
2. 止损止盈机制
3. 仓位管理
4. 风险监控

### Phase 4: 交易接口（2-3周）
1. QMT接口封装
2. 订单管理系统
3. 模拟交易测试
4. 实盘小资金测试

### Phase 5: 监控调度（1-2周）
1. 任务调度系统
2. 监控告警
3. 日志系统
4. 系统集成测试

### Phase 6: 优化迭代（持续）
1. 策略优化
2. 性能优化
3. 功能完善

---

## 七、关键注意事项

### 7.1 QMT/MiniQMT使用
- **申请条件**：通常需要满足资金门槛（如50万）
- **安装配置**：需要安装QMT客户端，配置Python环境
- **接口文档**：参考华泰证券提供的API文档
- **测试环境**：先使用模拟环境充分测试

### 7.2 风险控制
- **回撤容忍度**：虽然接受20-40%回撤，但仍需设置硬止损
- **仓位分散**：避免单只股票仓位过大
- **市场环境**：熊市时降低仓位，牛市时适当提高

### 7.3 合规性
- **API使用**：遵守华泰证券API使用规范
- **交易频率**：避免过于频繁交易（可能触发监管）
- **数据使用**：遵守数据源使用协议

### 7.4 系统稳定性
- **异常处理**：完善的异常捕获和处理机制
- **断线重连**：QMT连接断开自动重连
- **数据备份**：定期备份交易数据和配置

---

## 八、总结

本架构设计针对**个人A股量化交易**场景，重点关注：
1. **模块化设计**：便于开发和维护
2. **风险优先**：完善的风险控制机制
3. **渐进式开发**：从回测到模拟再到实盘
4. **自动化与人工平衡**：关键环节自动化，重要决策人工干预

建议按照开发优先级逐步实现，每个阶段充分测试后再进入下一阶段。

